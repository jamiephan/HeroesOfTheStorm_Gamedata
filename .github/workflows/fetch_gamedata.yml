name: Automatically Fetch Game Data Files
on:
  schedule:
    - cron: "0 */4 * * *"
  workflow_dispatch:
jobs:
  auto-fetch-gamedata:
    name: Automatically Fetch Game Data Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Set git to ignore case
        run: git config core.ignorecase true
      - name: Check game version
        id: check-version
        shell: bash
        run: |
          region_output=""
          build_id_output=""
          version_string_output=""

          # Find buildid.txt case-insensitively (including entire path)
          buildid_file=$(find "$GITHUB_WORKSPACE" -maxdepth 4 -ipath "*/mods/core.stormmod/base.stormdata/buildid.txt" -type f | head -n 1)

          if [ -n "$buildid_file" ] && [ -f "$buildid_file" ]; then
            region="us"

            # Fetch version information
            response=$(curl -s "http://us.patch.battle.net:1119/hero/versions")
            
            # Remove comment lines and get header
            response=$(echo "$response" | grep -v '^#')
            header=$(echo "$response" | head -n 1)
            configs=$(echo "$response" | tail -n +2)

            buildIdIndex=-1
            regionIndex=-1
            versionStringIndex=-1
            
            # Find column indices
            IFS='|' read -ra columns <<< "$header"
            for i in "${!columns[@]}"; do
              key="${columns[$i]}"
              key_lower=$(echo "$key" | tr '[:upper:]' '[:lower:]')
              
              if [[ "$key_lower" == region!* ]]; then
                regionIndex=$i
              fi
              if [[ "$key_lower" == buildid!* ]]; then
                buildIdIndex=$i
              fi
              if [[ "$key_lower" == versionsname!* ]]; then
                versionStringIndex=$i
              fi
            done

            # Loop through each config (region)
            while IFS= read -r config; do
              IFS='|' read -ra fields <<< "$config"
              regionExtracted="${fields[$regionIndex]}"
              
              if [[ "$regionExtracted" == "$region" ]]; then

                buildIdExtracted="${fields[$buildIdIndex]}"
                versionStringExtracted="${fields[$versionStringIndex]}"
                modsBuild=$(cat "$buildid_file")

                echo "Extracted Region: $regionExtracted"
                echo "Extracted Version String: $versionStringExtracted"
                echo "Extracted Build ID: B$buildIdExtracted"
                echo "Current Mods Build: $modsBuild"
                
                region_output="$regionExtracted"
                build_id_output="$buildIdExtracted"
                version_string_output="$versionStringExtracted"

                if [[ "$modsBuild" == "B$buildIdExtracted" ]]; then
                  echo "Error: Current Gamedata is up to date. Abort." >&2
                  exit 1
                fi
                break
              fi
            done <<< "$configs"
          else
            echo "Error: Build ID file not found" >&2
            exit 1
          fi

          echo "Github Action Output:"
          echo "region=${region_output}"
          echo "build_id=${build_id_output}"
          echo "version_string=${version_string_output}"

          echo "region=${region_output}" >> "$GITHUB_OUTPUT"
          echo "build_id=${build_id_output}" >> "$GITHUB_OUTPUT"
          echo "version_string=${version_string_output}" >> "$GITHUB_OUTPUT"
      - uses: actions/setup-node@v6
        with:
          node-version: 22
      - run: npm install
      - run: npm run extract
      - name: Generate XSD File
        shell: bash
        run: |
          gameVersion="${{ steps.check-version.outputs.version_string }}"

          if [ -z "$gameVersion" ]; then
            echo "Error: version_string output is empty, cannot generate XSD." >&2
            exit 1
          fi

          # Check if tree is not clean
          if [ -n "$(git status --porcelain)" ]; then
            echo "Game Version: $gameVersion"

            mkdir -p "./_temp_"
            mkdir -p "./xsd"
            
            echo "Copying XML files to temp"
            find "./mods" -type f -name "*.xml" | while read -r filePath; do
              filePathHash=$(md5sum "$filePath" | awk '{print $1}')
              cp "$filePath" "./_temp_/${filePathHash}.xml"
            done
            
            echo "Generating XSD File"
            java -jar "./trang.jar" -I xml -O xsd ./_temp_/*.xml "./xsd/$gameVersion.xsd"
            
            # Replace latest.xsd
            if [ -f "./xsd/latest.xsd" ]; then
              rm -f "./xsd/latest.xsd"
            fi
            java -jar "./trang.jar" -I xml -O xsd ./_temp_/*.xml "./xsd/latest.xsd"
          fi
      - name: Push Changes to Github
        shell: bash
        run: |
          gameVersion="${{ steps.check-version.outputs.version_string }}"

          if [ -z "$gameVersion" ]; then
            echo "Error: version_string output is empty, cannot push changes." >&2
            exit 1
          fi

          # Check if tree is not clean
          if [ -n "$(git status --porcelain)" ]; then
            echo "Game Version: $gameVersion"

            git config --global user.name 'Jamie Phan'
            git config --global user.email '9488815+jamiephan@users.noreply.github.com'

            git add "./mods"
            git add "./xsd"
            git commit -m "Updated Files to $gameVersion"

            commitHash=$(git log --format="%H" -n 1)
            git tag -a "v$gameVersion" "$commitHash" -m "Game Version: $gameVersion"

            echo "" >> "./VERSIONS.md"
            echo "- $gameVersion: [\`Commit\`](https://github.com/jamiephan/HeroesOfTheStorm_Gamedata/commit/$commitHash) | [\`Tag\`](https://github.com/jamiephan/HeroesOfTheStorm_Gamedata/releases/tag/v$gameVersion) | [\`XSD\`](./xsd/$gameVersion.xsd)" >> "./VERSIONS.md"
            git add "./VERSIONS.md"
            git commit -m "Updated VERSION.md with $gameVersion"
            git push
            git push --tags
          else
            echo "No changes have been made to git. No updates were found"
          fi
